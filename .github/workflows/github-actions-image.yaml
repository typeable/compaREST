name: Github Action Docker Image

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:
    inputs:
      release:
        description: Release the new version?
        required: false
        default: "true"
      version:
        description: The version to release
        required: true

jobs:
  build-github-action-image:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: Common setup
        uses: ./.github/actions/common_setup
        with:
          cachixSigningKey: ${{ secrets.CACHIX_SIGNING_KEY }}

      - name: Build Github Action Docker Image
        run: |
          cp $(nix-build -A compaRESTGithubAction -j auto) compaREST-Github-Action-image.tar.gz
          cp $(nix-build -A compaREST -j auto) compaREST-image.tar.gz

      - name: Build Linux static binary
        run: |
          mkdir compaREST-binary
          cp $(nix-build -A compaRESTBin -j auto) compaREST-binary/compaREST

      - name: Upload compaREST Github Action Image
        uses: actions/upload-artifact@v2
        with:
          name: compaREST-Github-Action-image
          path: compaREST-Github-Action-image.tar.gz

      - name: Upload compaREST Image
        uses: actions/upload-artifact@v2
        with:
          name: compaREST-image
          path: compaREST-image.tar.gz

      - name: Upload compaREST Linux Binary
        uses: actions/upload-artifact@v2
        with:
          name: compaREST-linux
          path: compaREST-binary/compaREST

      - name: Push Nightly Docker Images to DockerHub
        if: github.ref == 'refs/heads/master' && github.event_name == 'push'
        uses: ./.github/actions/push_docker_images
        with:
          tag: nightly
          docker_username: ${{ secrets.DOCKERHUB_USERNAME }}
          docker_password: ${{ secrets.DOCKERHUB_TOKEN }}

  release:
    name: Release
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.release == 'true'
    needs: [build-github-action-image]
    runs-on: "ubuntu-latest"
    steps:
      - uses: actions/checkout@v2
      - name: Common setup
        uses: ./.github/actions/common_setup
        with:
          cachixSigningKey: ${{ secrets.CACHIX_SIGNING_KEY }}

      - name: Push Docker Release Images to DockerHub
        uses: ./.github/actions/push_docker_images
        with:
          tag: ${{ github.event.inputs.version }}
          docker_username: ${{ secrets.DOCKERHUB_USERNAME }}
          docker_password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Push Docker latest Images to DockerHub
        uses: ./.github/actions/push_docker_images
        with:
          tag: latest
          docker_username: ${{ secrets.DOCKERHUB_USERNAME }}
          docker_password: ${{ secrets.DOCKERHUB_TOKEN }}

      - uses: actions/download-artifact@v2
      - name: Zip and move
        run: |
          chmod +x compaREST-linux/compaREST
          zip compaREST-linux compaREST-linux/compaREST

          mv compaREST-Github-Action-image/* .
          mv compaREST-image/* .
      - uses: "marvinpinto/action-automatic-releases@latest"
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          automatic_release_tag: "latest"
          prerelease: false
          title: "${{ github.event.inputs.version }}"
          files: |
            *.zip
            *.tar.gz
